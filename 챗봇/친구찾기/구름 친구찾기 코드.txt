from flask import Flask, request

import random

import MySQLdb



gender = None

age_group = None



application = Flask(__name__)



conn = MySQLdb.connect(host="localhost", port=3306, db='friendly', user='root', password='12345')



# ÏÑ±Î≥Ñ ÏÑ†ÌÉù

@application.route('/start02', methods=['POST'])

def select_gender():

    response = {

        "version": "2.0",

        "template": {

            "outputs": [

                {

                    "textCard": {

                        "title": "ÏπúÍµ¨Î•º Ï∞æÏïÑÎ≥ºÍπåÏöî?",

                        "description": "Ïñ¥Îñ§ ÏπúÍµ¨Î•º Ï∞æÏïÑÎ≥ºÍπåÏöî?. \n ÏÑ±Î≥ÑÏùÑ ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî!",

                        "buttons": [

                            {

                                "action": "message",

                                "label": "Ïó¨Ïûê",

                                "messageText": "Ïó¨Ïûê"

                            },

                            {

                                "action": "message",

                                "label": "ÎÇ®Ïûê",

                                "messageText": "ÎÇ®Ïûê"

                            },

                        ]

                    }

                }

            ]

        }

    }

    return response



# ÎÇòÏù¥ÎåÄ ÏÑ†ÌÉù

@application.route('/age', methods=['POST'])

def select_age():

    global gender



    body = request.get_json()

    gender = body['userRequest']['utterance']  # ÏÑ±Î≥Ñ ÏÑ†ÌÉùÎêú Í∞í

    

    response = {
    "version": "2.0",
    "template": {
        "outputs": [
            {
                "carousel": {
                    "type": "textCard",
                    "items": [
                        {
                            "title": "ÏπúÍµ¨Î•º Ï∞æÏïÑÎ≥ºÍπåÏöî?üíó",
                            "description": "Ïñ¥Îñ§ ÏπúÍµ¨Î•º Ï∞æÏïÑÎ≥ºÍπåÏöî?. \n ÎÇòÏù¥Î•º ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî!",
                            "buttons": [
                                {
                                    "action": "message",
                                    "label": "10ÎåÄ",
                                    "messageText": "10ÎåÄ"
                                },
                                {
                                    "action": "message",
                                    "label": "20ÎåÄ",
                                    "messageText": "20ÎåÄ"
                                },
                                {
                                    "action": "message",
                                    "label": "30ÎåÄ",
                                    "messageText": "30ÎåÄ"
                                }
                            ]
                        },
                        {
                            "title": "ÏπúÍµ¨Î•º Ï∞æÏïÑÎ≥ºÍπåÏöî?üíó",
                            "description": "Ïñ¥Îñ§ ÏπúÍµ¨Î•º Ï∞æÏïÑÎ≥ºÍπåÏöî?. \n ÎÇòÏù¥Î•º ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî!",
                            "buttons": [
                                {
                                    "action": "message",
                                    "label": "40ÎåÄ",
                                    "messageText": "40ÎåÄ"
                                },
                                {
                                    "action": "message",
                                    "label": "50ÎåÄ",
                                    "messageText": "50ÎåÄ"
                                }
                            ]
                        }
                    ]
                }
            }
        ]
    }
}
    return response



# ÏπúÍµ¨ Ï∂îÏ≤ú Í∏∞Îä•

@application.route('/sql', methods=['POST'])

def get_sql():

    global gender, age_group, conn

    

    body = request.get_json()

    age_group = body['userRequest']['utterance'].strip()  # ÎÇòÏù¥ ÏÑ†ÌÉùÎêú Í∞í

    

    cursor = conn.cursor()

    

    if age_group == '10ÎåÄ':

        age_group_query = 'age >= 10 AND age < 20'

    elif age_group == '20ÎåÄ':

        age_group_query = 'age >= 20 AND age < 30'

    elif age_group == '30ÎåÄ':

        age_group_query = 'age >= 30 AND age < 40'

    elif age_group == '40ÎåÄ':

        age_group_query = 'age >= 40 AND age < 50'

    elif age_group == '50ÎåÄ':

        age_group_query = 'age >= 50 AND age < 60'

    else:

        # age_groupÏù¥ Ïö∞Î¶¨Í∞Ä Ï†ïÏùòÌïú Í≤ÉÍ≥º ÏùºÏπòÌïòÏßÄ ÏïäÏùÑ Í≤ΩÏö∞ Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï

        age_group_query = 'age >= 0'



    if gender == 'Ïó¨Ïûê':

        gender_query = 'F'

    else:

        gender_query = 'M'

    

    sql = "SELECT name FROM customer WHERE gender = %s AND " + age_group_query

    cursor.execute(sql, (gender_query,))



    suppliers = cursor.fetchall()

    result = []



    for supplier in suppliers:

        output = []

        for i in range(len(supplier)):

            output.append(str(supplier[i]))

        result = result + output



    result = result[:6]

    str3 = random.sample(result, len(result))



    friend_games = {}

    friend_age = {}



    for name in str3:

        # Get games

        mysql = "SELECT game_name FROM customer WHERE name = %s"

        cursor.execute(mysql, (name,))

        games = cursor.fetchall()

        game_name = [game[0] for game in games]

        friend_games[name] = game_name



        # Get age

        msql = "SELECT age FROM customer WHERE name = %s"

        cursor.execute(msql, (name,))

        ages = cursor.fetchall()

        age_in = [str(age[0]) for age in ages]

        friend_age[name] = age_in



    cursor.close()

    return str3, friend_games, friend_age



@application.route('/power', methods=['POST'])

def friend():

    str3, friend_games, friend_age = get_sql()



    descriptions = []

    for i in range(min(3, len(str3))):

        friend_name = str3[i]

        games_list = friend_games.get(friend_name, [])

        description = ', '.join(games_list)

        descriptions.append(description)



    final_ages = []

    for i in range(min(3, len(str3))):

        friend_in = str3[i]

        age_list = friend_age.get(friend_in, [])

        final_age = ', '.join(age_list)

        final_ages.append(final_age)



    responseBody = {

        "version": "2.0",

        "template": {

            "outputs": [

                {

                    "listCard": {

                        "header": {

                            "title": "ÏπúÍµ¨Î•º Ï∂îÏ≤úÌï¥Ï§ÑÍ≤å"

                        },

                        "items": [

                            {

                                "title": "ÎãâÎÑ§ÏûÑ: " + str3[0],

                                "description": "# " + descriptions[0] + " #" + final_ages[0] + "ÏÇ¥ #" + gender,

                                "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FdAqmkb%2FbtsHBpCK2sR%2F5f2REVwRSQkiJ3qWkAcZkK%2Fimg.png",

                                "link": {

                                    "web": "https://www.naver.com"

                                }

                            },

                            {

                                "title": "ÎãâÎÑ§ÏûÑ: " + str3[1],

                                "description": "# " + descriptions[1] + " #" + final_ages[1] + "ÏÇ¥ #" + gender,

                                "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FdAqmkb%2FbtsHBpCK2sR%2F5f2REVwRSQkiJ3qWkAcZkK%2Fimg.png",

                                "link": {

                                    "web": "https://www.naver.com"

                                }

                            },

                            {

                                "title": "ÎãâÎÑ§ÏûÑ: " + str3[2],

                                "description": "# " + descriptions[2] + " #" + final_ages[2] + "ÏÇ¥ #" + gender,

                                "imageUrl": "https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FdAqmkb%2FbtsHBpCK2sR%2F5f2REVwRSQkiJ3qWkAcZkK%2Fimg.png",

                                "link": {

                                    "web": "https://www.naver.com"

                                }

                            }

                        ]

                    }

                }

            ]

        }

    }

    return responseBody



if __name__ == "__main__":

    application.run(host='0.0.0.0', port=80)